package com.proit.servicios.ventas;

import java.io.Serializable;
import java.math.BigDecimal;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Iterator;
import java.util.List;

import org.apache.wicket.util.string.Strings;
import org.hibernate.Criteria;
import org.hibernate.Query;
import org.hibernate.Session;
import org.hibernate.criterion.Order;
import org.hibernate.criterion.Projections;
import org.hibernate.criterion.Restrictions;

import com.proit.modelo.TipoFactura;
import com.proit.modelo.ventas.DetalleFacturaVenta;
import com.proit.modelo.ventas.EstadoFacturaVenta;
import com.proit.modelo.ventas.FacturaVenta;
import com.proit.servicios.GenericService;
import com.proit.utils.Constantes;
import com.proit.utils.Utils;
import com.proit.wicket.FacturarOnLineAuthenticatedWebApplication;

public class FacturaVentaService extends GenericService<FacturaVenta> implements Serializable {

	private static final long serialVersionUID = 1L;
	
	public FacturaVentaService() {
		super(FacturaVenta.class);
	}
	
	private Criteria definirCriteria(String razonSocialCliente, Integer idEvento, Calendar fecha, boolean soloXCobrarYParciales, List<String> nrosFacturasVenta, Calendar mes){
		Session session = FacturarOnLineAuthenticatedWebApplication.getHibernateSession();		
		Criteria criteria = session.createCriteria(FacturaVenta.class)
							.createAlias("cliente", "c")
							.createAlias("evento", "e");
		if (!Strings.isEmpty(razonSocialCliente)) {
			criteria.add(Restrictions.eq("c.razonSocial", razonSocialCliente));
		}
		if (idEvento!=null) {
			criteria.add(Restrictions.eq("e.id", idEvento));
		}
		if (fecha!=null) {
			criteria.add(Restrictions.eq("fecha", fecha));
		}
		if (soloXCobrarYParciales) {
			criteria.add(Restrictions.or(Restrictions.eq("estadoFacturaVenta", EstadoFacturaVenta.X_COBRAR),Restrictions.eq("estadoFacturaVenta", EstadoFacturaVenta.COBRADO_PARCIAL)));
		}
		if (nrosFacturasVenta!=null) {
			criteria.add(Restrictions.in("nro", nrosFacturasVenta));
		}
		
		if (mes!=null) {
			Calendar inicio = mes;
			Calendar fin = (Calendar) mes.clone();
			fin.add(Calendar.MONTH, 1);
			criteria.add(Restrictions.ge("fecha", inicio));
			criteria.add(Restrictions.lt("fecha", fin));
		}
		
		//No Traigo las Facturas Ficticias (las que comienzan con el Prefijo "S/F-")
		criteria.add(Restrictions.not(Restrictions.ilike("nro", Constantes.PREFIX_NRO_FACTURA_SF + "%")));
		criteria.add(Restrictions.eq("borrado", false));
		return criteria;
	}
	
	/**
	 * This method gets some info of {@link FacturaVenta}s from database.
	 * @param primerResultado First result to obtain.
	 * @param cantidadResultados Total {@link FacturaVenta}s to obtain.
	 * @return Returns {@link FacturaVenta}s from database.
	 */
	@SuppressWarnings("unchecked")
	public Iterator<FacturaVenta> getFacturas(long primerResultado, long cantidadResultados, String razonSocialCliente, Integer idEvento, Calendar fecha, boolean soloXCobrarYParciales, Calendar mes) {
		Criteria criteria = definirCriteria(razonSocialCliente, idEvento, fecha, soloXCobrarYParciales, null, mes);
		criteria.setFirstResult((int) primerResultado);
		criteria.setMaxResults((int) cantidadResultados);
		criteria.addOrder(Order.asc("nro"));
		return criteria.list().iterator();
	}
	
	public long getFacturasSize(String razonSocialCliente, Integer idEvento, Calendar fecha, boolean soloXCobrarYParciales, Calendar mes) {
		Criteria criteria = definirCriteria(razonSocialCliente, idEvento, fecha, soloXCobrarYParciales, null, mes);
		criteria.setProjection(Projections.rowCount());
		return (Long)criteria.uniqueResult();
	}
	
	@SuppressWarnings("unchecked")
	public List<FacturaVenta> getFacturas(String razonSocialCliente, Integer idEvento, Calendar fecha, boolean soloXCobrarYParciales, List<String> nrosFacturasVenta, Calendar mes) {
		Criteria criteria = definirCriteria(razonSocialCliente, idEvento, fecha, soloXCobrarYParciales, nrosFacturasVenta, mes);
//		criteria.addOrder(Order.asc("c.razonSocial"));
		criteria.addOrder(Order.asc("nro"));
		return criteria.list();
	}
		
	/**
	 * Verifica si la factura ya fue creada previamente utilizando el Tipo y Nro de Factura. 
	 * Se podria crear un nro de fact vta repetido si el TIPO es distinto 
	 * Ej : puede haber una fact a y una NC A con el mismo numero
	 * @param nroFacturaVenta
	 * @return
	 */
	public boolean nroFacturaAlreadyExists(TipoFactura tipoFactura, String nroFactura){
		Session session = FacturarOnLineAuthenticatedWebApplication.getHibernateSession();
		Criteria criteria = session.createCriteria(FacturaVenta.class)
									.createAlias("tipoFactura", "t");
		criteria.add(Restrictions.eq("t.id", tipoFactura.getId()));
		criteria.add(Restrictions.eq("nro", nroFactura));
		criteria.add(Restrictions.eq("borrado", false));
		criteria.setProjection(Projections.rowCount());
		return( (Long) criteria.uniqueResult() ) > 0;
	}
	
	/**
	 * Obtiene la FacturaVenta usando el Tipo y Nro de factura
	 * @param razonSocial
	 * @param nroFactura
	 * @return
	 */
	public FacturaVenta getFacturaByTipoYNroFactura(TipoFactura tipoFactura, String nroFactura) {
		Session session = FacturarOnLineAuthenticatedWebApplication.getHibernateSession();
		Criteria criteria = session.createCriteria(FacturaVenta.class)
									.createAlias("tipoFactura", "t");
		criteria.add(Restrictions.eq("t.id", tipoFactura.getId()));
		criteria.add(Restrictions.eq("nro", nroFactura));
		criteria.add(Restrictions.eq("borrado", false));
		return (FacturaVenta) criteria.uniqueResult();
	}

	public boolean todoDetalleTieneCantidadMayorACero(List<DetalleFacturaVenta> listaDetalles) {
		for (DetalleFacturaVenta detalle : listaDetalles){
			if (detalle.getCantidad()<1){
				return false;
			}
		}
		return true;
	}

	public boolean todoDetalleTieneImporteDistintoACero(List<DetalleFacturaVenta> listaDetalles) {
		for (DetalleFacturaVenta detalle : listaDetalles){
			if (detalle.getImporte()==0){
				return false;
			}
		}
		return true;
	}
	
	@SuppressWarnings("unchecked")
	private double sumarSubtotal(Calendar inicio, Calendar fin, Integer idEvento) {
		Session session = FacturarOnLineAuthenticatedWebApplication.getHibernateSession();
		DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
		String sqlString = "select f.tipo_factura_id, SUM(d.cantidad * d.importe) as subtotal ";
		sqlString += "from factura_venta f , detalle_factura_venta d ";
		sqlString += "where d.factura_venta_id = f.id ";
		sqlString += "and f.borrado = false and d.borrado = false ";
		sqlString += (inicio!=null&&fin!=null) ? "and f.fecha >= '"+dateFormat.format(inicio.getTime())+"' and f.fecha < '"+dateFormat.format(fin.getTime())+"' " : "";
		//sqlString += "and f.fecha >= '2016-07-01' and f.fecha < '2016-07-29' ";
		sqlString += idEvento!=null ? "and f.evento_id = " + idEvento + " " : "";
		sqlString += "group by tipo_factura_id";
		Query sqlQuery = session.createSQLQuery(sqlString);
		List<Object[]> queryResult = sqlQuery.list();
		double result = 0d;
		for (Object[] obj : queryResult) {
			int idTipoFactura = ((Integer) obj[0]).intValue();
			double valor = ((BigDecimal) obj[1]).doubleValue();
			if (idTipoFactura == TipoFactura.NOTA_CRED_A.getId() || idTipoFactura == TipoFactura.NOTA_CRED_B.getId() || idTipoFactura == TipoFactura.NOTA_CRED_C.getId()) {
				result -= valor;
			} else {
				result += valor;
			}
		}
		return result;
	}
	
	@SuppressWarnings("unchecked")
	private double sumarIVA(Calendar inicio, Calendar fin, Integer idEvento) {
		Session session = FacturarOnLineAuthenticatedWebApplication.getHibernateSession();
		DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");		
		String sqlString = "select tipo_factura_id as tipo_factura_id, SUM(iva) as iva from ( ";
		sqlString += "select f.tipo_factura_id as tipo_factura_id, ";
		sqlString += "CASE WHEN (f.tipo_factura_id="+TipoFactura.TIPO_A.getId()+" or f.tipo_factura_id="+TipoFactura.NOTA_DEB_A.getId()+" or f.tipo_factura_id="+TipoFactura.NOTA_CRED_A.getId()+") THEN (d.cantidad * d.importe * 0.21) ";
		sqlString += " ELSE 0 ";
		sqlString += "END as iva ";
		sqlString += "from factura_venta f , detalle_factura_venta d ";
		sqlString += "where d.factura_venta_id = f.id ";
		sqlString += "and f.borrado = false and d.borrado = false ";		
		sqlString += (inicio!=null&&fin!=null) ? "and f.fecha >= '"+dateFormat.format(inicio.getTime())+"' and f.fecha < '"+dateFormat.format(fin.getTime())+"' " : "";		
		//sqlString += "and f.fecha >= '2016-07-01' and f.fecha < '2016-07-29' ";
		sqlString += idEvento!=null ? "and f.evento_id = " + idEvento + " " : "";
		sqlString += ") as calculo_iva ";
		sqlString += "group by tipo_factura_id ";
		Query sqlQuery = session.createSQLQuery(sqlString);
		List<Object[]> queryResult = sqlQuery.list();
		double result = 0d;
		for (Object[] obj : queryResult) {
			int idTipoFactura = ((Integer) obj[0]).intValue();
			double valor = ((BigDecimal) obj[1]).doubleValue();
			if (idTipoFactura == TipoFactura.NOTA_CRED_A.getId() || idTipoFactura == TipoFactura.NOTA_CRED_B.getId() || idTipoFactura == TipoFactura.NOTA_CRED_C.getId()) {
				result -= valor;
			} else {
				result += valor;
			}
		}
		return result;
	}
	
	public double calculateSumSubtotalMensual(Calendar mes){
		Calendar inicio = mes;
		Calendar fin = (Calendar) mes.clone();
		fin.add(Calendar.MONTH, 1);
		return sumarSubtotal(inicio, fin, null);
	}
	
	public double calculateSumSubtotalAnual(Calendar mesInicialAño){
		mesInicialAño.set(Calendar.MONTH, mesInicialAño.getMinimum(Calendar.MONTH));
		mesInicialAño.set(Calendar.DAY_OF_MONTH, 1);
		mesInicialAño = Utils.firstMillisecondOfDay(mesInicialAño);
		
		Calendar mesInicialAñoSiguiente = (Calendar) mesInicialAño.clone();
		mesInicialAñoSiguiente.add(Calendar.YEAR, 1);
		
		return sumarSubtotal(mesInicialAño, mesInicialAñoSiguiente, null);
	}
	
	public double calculateSumSubtotalPorEvento(Integer idEvento){		
		return sumarSubtotal(null, null, idEvento);
	}
	
	public double calculateSumIVAMensual(Calendar mes){
		Calendar inicio = mes;
		Calendar fin = (Calendar) mes.clone();
		fin.add(Calendar.MONTH, 1);
		return sumarIVA(inicio, fin, null);
	}
	
	public double calculateSumIVAPorEvento(Integer idEvento){		
		return sumarIVA(null, null, idEvento);
	}
		
}
